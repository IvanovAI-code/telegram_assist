import os
import logging
from faster_whisper import WhisperModel

logger = logging.getLogger(__name__)

class WhisperService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""

    def __init__(self, model_size: str = "base"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Whisper –º–æ–¥–µ–ª–∏

        –†–∞–∑–º–µ—Ä—ã –º–æ–¥–µ–ª–µ–π (–æ—Ç –±—ã—Å—Ç—Ä–æ–π –∫ —Ç–æ—á–Ω–æ–π):
        - tiny: 39M –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–∞—è, –±–∞–∑–æ–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
        - base: 74M –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –±—ã—Å—Ç—Ä–∞—è, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ ‚Üê –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º
        - small: 244M, –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
        - medium: 769M, –º–µ–¥–ª–µ–Ω–Ω–∞—è, –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ
        - large: 1550M, –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ

        –î–ª—è i3 8100 + 8GB RAM –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ: base –∏–ª–∏ tiny
        """
        logger.info(f"üé§ –ó–∞–≥—Ä—É–∂–∞–µ–º Whisper –º–æ–¥–µ–ª—å: {model_size}")

        # device="cpu" - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä, –Ω–µ GPU
        # compute_type="int8" - –∏—Å–ø–æ–ª—å–∑—É–µ–º 8-–±–∏—Ç–Ω—ã–µ —á–∏—Å–ª–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
        self.model = WhisperModel(
            model_size,
            device="cpu",
            compute_type="int8"
        )

        logger.info("‚úÖ Whisper –º–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞!")

    async def transcribe(self, audio_path: str) -> str:
        """
        –†–∞—Å–ø–æ–∑–Ω–∞—ë–º –≥–æ–ª–æ—Å –∏–∑ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞

        Args:
            audio_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª—É

        Returns:
            –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        try:
            # –†–∞—Å–ø–æ–∑–Ω–∞—ë–º –∞—É–¥–∏–æ
            # language="ru" - —É–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ —è–≤–Ω–æ (—Ä–∞–±–æ—Ç–∞–µ—Ç –ª—É—á—à–µ –¥–ª—è —Å–ø–µ—Ü—Ç–µ—Ä–º–∏–Ω–æ–≤)
            # beam_size=10 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
            # vad_filter=True - —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–∏—à–∏–Ω—É –∏ —à—É–º—ã
            # word_timestamps=False - –Ω–µ –Ω—É–∂–Ω—ã –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å–ª–æ–≤
            # initial_prompt - –ø–æ–¥—Å–∫–∞–∑–∫–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å–ø–µ—Ü—Ç–µ—Ä–º–∏–Ω–æ–≤
            initial_prompt = "–ö–∏–∞ –†–∏–æ, –•–µ–Ω–¥–∞–π, –¢–æ–π–æ—Ç–∞, –º–∞–≥–Ω–∏—Ç–æ–ª–∞, —Ä–∞—Å–ø–∏–Ω–æ–≤–∫–∞, –∞–≤—Ç–æ–º–æ–±–∏–ª—å, –º–∞—à–∏–Ω–∞"

            segments, info = self.model.transcribe(
                audio_path,
                language="ru",
                beam_size=10,
                vad_filter=True,
                word_timestamps=False,
                initial_prompt=initial_prompt
            )

            # –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∏–∑ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
            text = " ".join([segment.text for segment in segments])

            logger.info(f"üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {text[:50]}...")

            return text.strip()

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}")
            raise

        finally:
            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            if os.path.exists(audio_path):
                os.remove(audio_path)

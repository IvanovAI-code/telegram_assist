from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message, URLInputFile, InputMediaPhoto
from services.deepseek import DeepSeekService
from services.serper import SerperService

# Router = –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
router = Router()

# –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —Å–µ—Ä–≤–∏—Å–æ–≤
deepseek = DeepSeekService()
serper = SerperService()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤ (–ø–æ chat_id)
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {chat_id: [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}, ...]}
conversation_history = {}
MAX_HISTORY_MESSAGES = 20  # –ú–∞–∫—Å–∏–º—É–º 20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ (10 –ø–∞—Ä –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç - –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–æ–ª—å AI
SYSTEM_PROMPT = """–¢—ã –ª–∏—á–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤ Telegram.
–ü–æ–º–æ–≥–∞–µ—à—å —Å –∑–∞–¥–∞—á–∞–º–∏, –ø—Ä–∏–≤—ã—á–∫–∞–º–∏, –ø–∏—Ç–∞–Ω–∏–µ–º –∏ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.
–û–±—â–∞–π—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –ø–æ-—Ä—É—Å—Å–∫–∏.

–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –ö–†–ê–¢–ö–û. –ú–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤."""


def get_conversation_history(chat_id: int) -> list:
    """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if chat_id not in conversation_history:
        conversation_history[chat_id] = []
    return conversation_history[chat_id]


def add_to_history(chat_id: int, role: str, content: str):
    """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞"""
    history = get_conversation_history(chat_id)
    history.append({"role": role, "content": content})

    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
    if len(history) > MAX_HISTORY_MESSAGES:
        # –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ MAX_HISTORY_MESSAGES
        conversation_history[chat_id] = history[-MAX_HISTORY_MESSAGES:]


@router.message(Command("start"))
async def cmd_start(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start

    @ = –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä (–≤–µ—à–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —Å–æ–±—ã—Ç–∏–µ)
    router.message = —Å–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    Command("start") = —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /start
    """
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ, –∏ —è –ø–æ–º–æ–≥—É!\n"
        "–¢–∞–∫–∂–µ –º–æ–≥—É –ø–æ–Ω–∏–º–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ù–∞—á–∞—Ç—å\n"
        "/help - –ü–æ–º–æ—â—å\n"
        "/search <–∑–∞–ø—Ä–æ—Å> - –ü–æ–∏—Å–∫ –≤ Google"
    )


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    await message.answer(
        "ü§ñ –Ø —É–º–µ—é:\n\n"
        "‚úÖ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n"
        "‚úÖ –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã\n"
        "‚úÖ –ü–æ–º–æ–≥–∞—Ç—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º\n"
        "‚úÖ –ü–æ–Ω–∏–º–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è\n"
        "‚úÖ –ò—Å–∫–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/start - –ù–∞—á–∞—Ç—å\n"
        "/help - –ü–æ–º–æ—â—å\n"
        "/search <–∑–∞–ø—Ä–æ—Å> - –ü–æ–∏—Å–∫ –≤ Google\n\n"
        "–°–∫–æ—Ä–æ –Ω–∞—É—á—É—Å—å:\n"
        "üîú –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏\n"
        "üîú –¢—Ä–µ–∫–∏–Ω–≥ –ø—Ä–∏–≤—ã—á–µ–∫"
    )


@router.message(Command("search"))
async def cmd_search(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /search

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /search –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
    """
    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    query = message.text.replace("/search", "").strip()

    if not query:
        await message.answer(
            "‚ùå –£–∫–∞–∂–∏ —á—Ç–æ –∏—Å–∫–∞—Ç—å!\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /search <–∑–∞–ø—Ä–æ—Å>\n"
            "–ü—Ä–∏–º–µ—Ä: /search —Ä–∞—Å–ø–∏–Ω–æ–≤–∫–∞ –º–∞–≥–Ω–∏—Ç–æ–ª—ã –∫–∏–∞ —Ä–∏–æ"
        )
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±–æ—Ç "–¥—É–º–∞–µ—Ç"
    await message.bot.send_chat_action(
        chat_id=message.chat.id,
        action="typing"
    )

    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        status_msg = await message.answer("üîç –ò—â—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ...")

        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
        search_results = await serper.search(query, num_results=5)

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        formatted_results = serper.format_results(search_results)

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        await status_msg.edit_text("ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã AI –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        ai_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–∫–∞–ª: "{query}"

–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:
{formatted_results}

–î–∞–π –∫—Ä–∞—Ç–∫–∏–π, –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
–ù–µ –ø–∏—à–∏ –ø—Ä–æ —Ç–æ —á—Ç–æ "–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞" - –ø—Ä–æ—Å—Ç–æ –¥–∞–π –æ—Ç–≤–µ—Ç –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã —ç—Ç–æ –∑–Ω–∞–µ—à—å."""

        ai_response = await deepseek.chat(
            user_message=ai_prompt,
            system_prompt="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—ë—Ç –∫—Ä–∞—Ç–∫–∏–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞. –û—Ç–≤–µ—á–∞–π –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã."
        )

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await status_msg.delete()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç AI
        await message.answer(f"üîç {ai_response}")

    except Exception as e:
        await message.answer(
            f"üòî –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: {str(e)}\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑."
        )


@router.message(F.text)
async def handle_text(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

    F.text = —Ñ–∏–ª—å—Ç—Ä (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –Ω–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)
    """

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±–æ—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç"
    await message.bot.send_chat_action(
        chat_id=message.chat.id,
        action="typing"
    )

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
        check_prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å: "{message.text}"

–ü–æ–∏—Å–∫ –ù–£–ñ–ï–ù –µ—Å–ª–∏:
- –°–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø–æ–≥–æ–¥—É, –∫—É—Ä—Å –≤–∞–ª—é—Ç, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
- –°–ø—Ä–∞—à–∏–≤–∞—é—Ç —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
- –ù—É–∂–Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä–∞—Å–ø–∏–Ω–æ–≤–∫–∞, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- –°–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Å–æ–±—ã—Ç–∏—è, –¥–∞—Ç—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

–ü–æ–∏—Å–∫ –ù–ï –ù–£–ñ–ï–ù –µ—Å–ª–∏:
- –û–±—ã—á–Ω—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
- –°–ø—Ä–∞—à–∏–≤–∞—é—Ç –º–Ω–µ–Ω–∏–µ, —Å–æ–≤–µ—Ç
- –í–æ–ø—Ä–æ—Å –æ –ª–∏—á–Ω–æ–º –æ–ø—ã—Ç–µ –∏–ª–∏ —á—É–≤—Å—Ç–≤–∞—Ö

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: "–¥–∞" –∏–ª–∏ "–Ω–µ—Ç"."""

        need_search = await deepseek.chat(
            user_message=check_prompt,
            system_prompt="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–µ–Ω –ª–∏ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ '–¥–∞' –∏–ª–∏ '–Ω–µ—Ç'."
        )

        # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ–∏—Å–∫ - –≤—ã–ø–æ–ª–Ω—è–µ–º
        if "–¥–∞" in need_search.lower():
            await message.answer("üîç –°–µ–π—á–∞—Å –ø–æ–≥—É–≥–ª—é...")

            # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
            search_results = await serper.search(message.text, num_results=5)
            formatted_results = serper.format_results(search_results)

            # AI –¥–∞—ë—Ç –∫—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞
            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            history = get_conversation_history(message.chat.id)

            ai_prompt = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª: "{message.text}"

–í–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:
{formatted_results}

–î–∞–π –∫—Ä–∞—Ç–∫–∏–π, –ø–æ–ª–µ–∑–Ω—ã–π –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.
–ù–µ –ø–∏—à–∏ –ø—Ä–æ —Ç–æ —á—Ç–æ "–ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–æ–∏—Å–∫–∞" - –ø—Ä–æ—Å—Ç–æ –¥–∞–π –æ—Ç–≤–µ—Ç –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã —ç—Ç–æ –∑–Ω–∞–µ—à—å."""

            ai_response = await deepseek.chat(
                user_message=ai_prompt,
                system_prompt="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—ë—Ç –∫—Ä–∞—Ç–∫–∏–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∏—Å–∫–∞. –û—Ç–≤–µ—á–∞–π –ø–æ –¥–µ–ª—É, –±–µ–∑ –≤–æ–¥—ã.",
                history=history
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∞ –Ω–µ –ø—Ä–æ–º–ø—Ç)
            add_to_history(message.chat.id, "user", message.text)
            add_to_history(message.chat.id, "assistant", ai_response)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω—ã –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            need_images_prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏, –Ω—É–∂–Ω—ã –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Ñ–æ—Ç–æ/—Å—Ö–µ–º—ã –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å: "{message.text}"

–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ù–£–ñ–ù–´ –µ—Å–ª–∏:
- –°–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ —Ä–∞—Å–ø–∏–Ω–æ–≤–∫—É, —Å—Ö–µ–º—ã, —á–µ—Ä—Ç–µ–∂–∏
- –ù—É–∂–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (–¥–∏–∞–≥—Ä–∞–º–º—ã, –≥—Ä–∞—Ñ–∏–∫–∏)
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å—Ö–µ–º—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –§–æ—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ù–ï –ù–£–ñ–ù–´ –µ—Å–ª–∏:
- –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
- –ü–æ–≥–æ–¥–∞, –Ω–æ–≤–æ—Å—Ç–∏, –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –±–µ–∑ –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å–æ—Å—Ç–∞–≤–ª—è—é—â–µ–π

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: "–¥–∞" –∏–ª–∏ "–Ω–µ—Ç"."""

            need_images = await deepseek.chat(
                user_message=need_images_prompt,
                system_prompt="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω—ã –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ '–¥–∞' –∏–ª–∏ '–Ω–µ—Ç'."
            )

            # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –∏—â–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
            if "–¥–∞" in need_images.lower():
                try:
                    image_urls = await serper.search_images(message.text, num_results=2)

                    if image_urls:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
                        await message.answer(ai_response)

                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        for img_url in image_urls:
                            try:
                                photo = URLInputFile(img_url)
                                await message.answer_photo(photo, caption="üì∏")
                            except Exception as img_err:
                                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                                continue
                        return
                except Exception as e:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                    pass
        else:
            # –û–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –ø–æ–∏—Å–∫–∞, —Å —É—á—ë—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏
            history = get_conversation_history(message.chat.id)

            ai_response = await deepseek.chat(
                user_message=message.text,
                system_prompt=SYSTEM_PROMPT,
                history=history
            )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            add_to_history(message.chat.id, "user", message.text)
            add_to_history(message.chat.id, "assistant", ai_response)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(ai_response)

    except Exception as e:
        # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(
            f"üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á—É—Ç—å –ø–æ–∑–∂–µ."
        )
